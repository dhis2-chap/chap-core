<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Integrating External Models with DHIS2 through CHAP - Climate Health 1.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../_static/_static/" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Climate Health 1.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <span class="sidebar-brand-text">Climate Health 1.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../modeling-app/index.html">Using Chap Core with DHIS2 Modeling App</a><input aria-label="Toggle navigation of Using Chap Core with DHIS2 Modeling App" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../modeling-app/running-chap-on-server.html">Configure DHIS2 Modeling App and Chap Core to work together</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="index.html">Documentation for model developers</a><input aria-label="Toggle navigation of Documentation for model developers" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="chap-dhis2-connection.html">Chap’s native connection to DHIS2 and the DHIS2 Modelling App</a></li>
<li class="toctree-l2"><a class="reference internal" href="chap_evaluate_examples.html">Examples of chap evaluate commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="describe_model.html">Describing your model in our yaml-based format</a></li>
<li class="toctree-l2"><a class="reference internal" href="experienced_modeller.html">Documentation for experienced modellers</a></li>
<li class="toctree-l2"><a class="reference internal" href="newcomer.html">Introduction to principles of spatiotemporal modelling and streamlined implementation of models through Chap</a></li>
<li class="toctree-l2"><a class="reference internal" href="newcomer.html#to-be-updated-developing-your-own-custom-model-with-chap">(to be updated) Developing your own custom model with CHAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_models_in_chap.html">Running models through Chap</a></li>
<li class="toctree-l2"><a class="reference internal" href="running_models_in_chap.html#running-models-through-the-chap-command-line-interface">Running models through the Chap command-line interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="side_by_side_comparison.html">Evaluating your model side-by-side with a range of other models</a></li>
<li class="toctree-l2"><a class="reference internal" href="supporting_functionality.html">Chap’s broad range of supporting functionality for modelling</a></li>
<li class="toctree-l2"><a class="reference internal" href="train_and_predict.html">Making chap-compatible train and predict endpoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="chapkit.html">Running models with chapkit</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../chap-cli/index.html">Using the CLI Tool</a><input aria-label="Toggle navigation of Using the CLI Tool" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../chap-cli/chap-core-cli-setup.html">Setting up CHAP-Core CLI Tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chap-cli/earth-engine-auth.html">CHAP Core Credentials for Google Earth Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chap-cli/using-pa-with-cli.html">Use JSON-file from DHIS2 Modeling App with CHAP Core CLI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chap-cli/downloaded_json_data.html">Running on JSON Data Downloaded from the DHIS2 Modeling App</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contributor/index.html">Contributor guide</a><input aria-label="Toggle navigation of Contributor guide" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributor/getting_started.html">Contributor getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/chap-contributor-setup.html">Setting Up CHAP Core as a Contributor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/windows_contributors.html">Important note for Windows contributors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/code_overview.html">Code overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/vocabulary.html">Vocabulary (domain specific terms used in the code)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/testing.html">Testing while developing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/writing_building_documentation.html">Writing and building documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/r_docker_image.html">Creating a docker image for R models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/development_tools.html">Introduction to Development Tools</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../webapi/index.html">Chap REST API</a><input aria-label="Toggle navigation of Chap REST API" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../webapi/developer.html">Using Chap REST API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../webapi/docker-compose-doc.html">Setting up Chap REST-API locally</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Releases and Future Plans</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/external_models/surplus_after_refactoring.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="integrating-external-models-with-dhis2-through-chap">
<h1>Integrating External Models with DHIS2 through CHAP<a class="headerlink" href="#integrating-external-models-with-dhis2-through-chap" title="Link to this heading">¶</a></h1>
<p>Assuming you have CHAP running on a server with DHIS2 (<a class="reference internal" href="../modeling-app/running-chap-on-server.html"><span class="std std-doc">see this guide</span></a>), it is possible to
make new external models available.</p>
<p>Currently, CHAP has an internal registry of models that can be used.<br />
If you want to run a model that is not in the registry, this now has to be done by editing the local CHAP code at the server.<br />
However, we are working on making this more flexible. For now, please reach out if you want a new model to be added to the internal registry in a given installation.</p>
<p>The following figure shows how the train and predict entry points are part of a data flow between DHIS2 and the external model:</p>
<p><img alt="External model integration with DHIS2" src="external_models/dhis_chap_integration.jpg" /></p>
</section>
<section id="overview-of-supported-models">
<h1>Overview of supported models<a class="headerlink" href="#overview-of-supported-models" title="Link to this heading">¶</a></h1>
<section id="autoregressive-weekly">
<h2>Autoregressive weekly<a class="headerlink" href="#autoregressive-weekly" title="Link to this heading">¶</a></h2>
<p>This model has been developed internally by the Chap team. Autoregressive weekly is a deep learning model based on DeepAR that uses rainfall and temperature as climate predictors and models disease counts with a negative binomial distribution where the parameters are estimated by a recurrent neural network. The current model available through Chap can be <a class="reference external" href="https://github.com/knutdrand/weekly_ar_model">found here</a>.</p>
</section>
<section id="epidemiar">
<h2>Epidemiar<a class="headerlink" href="#epidemiar" title="Link to this heading">¶</a></h2>
<p>Epidemiar is a Generalizes additive model (GAM) used for climate health forecasts. It requires weekly epidemilogical data, like disease cases and population, and daily enviromental data. As most of the data in CHAP is monthly or weekly we pass weakly data to the model, and then naively expand weekly data to daily data, which the epidemiar library again aggregates back to weekly data. The model produces a sample for each location per time point with and upper and lower boundary for some unknown quantiles. For more information regarding the model look <a class="reference external" href="https://github.com/dhis2-chap/epidemiar_example_model">here</a>. An example of running the model from the CHAP command line interface is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chap</span> <span class="n">evaluate</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">name</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dhis2</span><span class="o">-</span><span class="n">chap</span><span class="o">/</span><span class="n">epidemiar_example_model</span> <span class="o">--</span><span class="n">dataset</span><span class="o">-</span><span class="n">csv</span> <span class="n">LOCAL_FILE_PATH</span><span class="o">/</span><span class="n">laos_test_data</span><span class="o">.</span><span class="n">csv</span> <span class="o">--</span><span class="n">report</span><span class="o">-</span><span class="n">filename</span> <span class="n">report</span><span class="o">.</span><span class="n">pdf</span> <span class="o">--</span><span class="n">debug</span> <span class="o">--</span><span class="n">n</span><span class="o">-</span><span class="n">splits</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
<p>which requires that <code class="docutils literal notranslate"><span class="pre">laos_test_data</span></code> is saved locally, but we are working on making weekly datasets available internaly in CHAP.</p>
</section>
<section id="ewars">
<h2>EWARS<a class="headerlink" href="#ewars" title="Link to this heading">¶</a></h2>
<p>EWARS is a Bayesian hierarchical model implemented with the INLA library. We use a negative binomial likelihood in the observation layer and combine several latent effect, both spatial and temporal, in the latent layer. The latent layer is log-transformed and scaled by the population, so it effectivaly models the proprotion of cases in each region. Specifically the latent layers combine a first order cyclic random walk to capture the seasonal effect, this is also included in the lagged exogenous variables rainfall and temperature, then a spatial smoothing with an ICAR and an iid effect to capture the spatial heterogeneity. The ICAR and iid can also be combined, scaled and reparameterized to the BYM2 model. Further information is available in the <a class="reference external" href="https://github.com/dhis2-chap/chap_auto_ewars">model repository</a>. An example of running the model from the CHAP command line interface is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chap</span> <span class="n">evaluate</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">name</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dhis2</span><span class="o">-</span><span class="n">chap</span><span class="o">/</span><span class="n">chap_auto_ewars</span> <span class="o">--</span><span class="n">dataset</span><span class="o">-</span><span class="n">name</span> <span class="n">ISIMIP_dengue_harmonized</span> <span class="o">--</span><span class="n">dataset</span><span class="o">-</span><span class="n">country</span> <span class="n">vietnam</span> <span class="o">--</span><span class="n">report</span><span class="o">-</span><span class="n">filename</span> <span class="n">report</span><span class="o">.</span><span class="n">pdf</span> <span class="o">--</span><span class="n">debug</span> <span class="o">--</span><span class="n">n</span><span class="o">-</span><span class="n">splits</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
</section>
<section id="arima">
<h2>ARIMA<a class="headerlink" href="#arima" title="Link to this heading">¶</a></h2>
<p>A general ARIMA model is a timeseries model with an autoregressive part, a moving average part and the option to difference the original timeseries, often to make it stationary. Additonally we have lagged rainfall and temperature, which actually makes this an ARIMAX model, where the X indicates exogenous variables. This model handles each region individually and it expects monthly data for all the covariates. The model utilizes the <code class="docutils literal notranslate"><span class="pre">arima</span></code> function which chooses the order of the differencing, autoregression and the moving average for us. Further information is available in the <a class="reference external" href="https://github.com/dhis2-chap/Madagascar_ARIMA">model repository</a>. An example of running the model from the CHAP command line interface is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chap</span> <span class="n">evaluate</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">name</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dhis2</span><span class="o">-</span><span class="n">chap</span><span class="o">/</span><span class="n">Madagascar_ARIMA</span> <span class="o">--</span><span class="n">dataset</span><span class="o">-</span><span class="n">name</span> <span class="n">ISIMIP_dengue_harmonized</span> <span class="o">--</span><span class="n">dataset</span><span class="o">-</span><span class="n">country</span> <span class="n">vietnam</span> <span class="o">--</span><span class="n">report</span><span class="o">-</span><span class="n">filename</span> <span class="n">report</span><span class="o">.</span><span class="n">pdf</span> <span class="o">--</span><span class="n">debug</span> <span class="o">--</span><span class="n">n</span><span class="o">-</span><span class="n">splits</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
</section>
</section>
<section id="wrapping-gluonts-models">
<h1>Wrapping GluonTS models<a class="headerlink" href="#wrapping-gluonts-models" title="Link to this heading">¶</a></h1>
<p>GluonTS provides a set of models that can be used for probabilistic time-series forecasting.
Here, we show how we can wrap these models into CHAP models, to enable using them on spatio-temporal data and to evalutate them against other models.</p>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">DeepAREstimator</span></code> model from GluonTS, which is a deep learning model based on an RNN architecture. For this simple example we use
a model that does not take weather into account, but only the the auto-regressive time series data.
Let’s start by loading the data and the model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">climate_health.data.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">ISIMIP_dengue_harmonized</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepAREstimator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gluonts.torch.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">NegativeBinomialOutput</span>

<span class="c1"># Load the data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ISIMIP_dengue_harmonized</span><span class="p">[</span><span class="s1">&#39;vietnam&#39;</span><span class="p">]</span>

<span class="c1"># Define the DeepAR model</span>
<span class="n">n_locations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
<span class="n">prediction_length</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">deep_ar</span> <span class="o">=</span>  <span class="n">DeepAREstimator</span><span class="p">(</span>
    <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">hidden_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="n">dropout_rate</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">num_feat_static_cat</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">embedding_dimension</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">cardinality</span><span class="o">=</span><span class="p">[</span><span class="n">n_locations</span><span class="p">],</span>
    <span class="n">prediction_length</span><span class="o">=</span><span class="n">prediction_length</span><span class="p">,</span>
    <span class="n">distr_output</span><span class="o">=</span><span class="n">NegativeBinomialOutput</span><span class="p">(),</span>
    <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>

    <span class="c1"># Wrap the model in a CHAP model</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">climate_health.adapters.gluonts</span><span class="w"> </span><span class="kn">import</span> <span class="n">GluonTSEstimator</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">GluonTSEstimator</span><span class="p">(</span><span class="n">gluonts_model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>The model now is a chap compatible model and we can run our evaluation pipeline on it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">climate_health.evaluation</span><span class="w"> </span><span class="kn">import</span> <span class="n">evaluate_model</span>

<span class="n">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">prediction_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_test_sets</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">report_filename</span><span class="o">=</span><span class="s1">&#39;gluonts_deepar_results.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<section id="running-an-external-model-in-python">
<h2>Running an external model in Python<a class="headerlink" href="#running-an-external-model-in-python" title="Link to this heading">¶</a></h2>
<p>CHAP contains an API for loading models through Python. The following shows an example of loading and evaluating three different models by specifying paths/github urls, and evaluating those models:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">chap_core.assessment.prediction_evaluator</span><span class="w"> </span><span class="kn">import</span> <span class="n">evaluate_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chap_core.external.external_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_model_from_directory_or_github_url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chap_core.file_io.file_paths</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_models_path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">chap_core.file_io.example_data_set</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">models_path</span> <span class="o">=</span> <span class="n">get_models_path</span><span class="p">()</span>
    <span class="n">model_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">#&#39;deepar&#39;: models_path / &#39;deepar&#39;,</span>
        <span class="s1">&#39;naive_model&#39;</span><span class="p">:</span> <span class="n">models_path</span> <span class="o">/</span> <span class="s1">&#39;naive_python_model_with_mlproject_file&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;ewars&#39;: &#39;https://github.com/sandvelab/chap_auto_ewars&#39;</span>
    <span class="p">}</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;ISIMIP_dengue_harmonized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;vietnam&#39;</span><span class="p">]</span>
    <span class="n">n_tests</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">prediction_length</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">all_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">get_model_from_directory_or_github_url</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span>
                                 <span class="n">prediction_length</span><span class="o">=</span><span class="n">prediction_length</span><span class="p">,</span>
                                 <span class="n">n_test_sets</span><span class="o">=</span><span class="n">n_tests</span><span class="p">,</span>
                                 <span class="n">report_filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">n_tests</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">prediction_length</span><span class="si">}</span><span class="s1">_report.pdf&#39;</span><span class="p">)</span>
        <span class="n">all_results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>

    <span class="n">report_file</span> <span class="o">=</span> <span class="s1">&#39;evaluation_report.csv&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">all_results</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">report_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

</pre></div>
</div>
</section>
</section>
<section id="docker-compose-chap-core">
<h1>Docker Compose (CHAP Core)<a class="headerlink" href="#docker-compose-chap-core" title="Link to this heading">¶</a></h1>
<p>Starting CHAP Core using Docker Compose is specifically for those who want to use the CHAP Core REST-API, either together with other services or with the Modeling App installed on a DHIS2 server. See documentation for <a class="reference internal" href="#modeling-app/modeling-app.md"><span class="xref myst">Modeling App</span></a> for instructions on how to install the Modeling App.</p>
<p><strong>Requirements</strong></p>
<ul class="simple">
<li><p>Access to credentials for Google Earth Engine. (Google Service Account Email and Private Key)</p></li>
</ul>
<section id="install-docker-if-not-installed">
<h2>1. Install Docker (if not installed)<a class="headerlink" href="#install-docker-if-not-installed" title="Link to this heading">¶</a></h2>
<p><strong>Docker</strong> is a platform for developing, shipping, and running applications inside containers.</p>
<p>To download and install Docker, visit the official Docker website: <a class="reference external" href="https://docs.docker.com/get-started/get-docker">https://docs.docker.com/get-started/get-docker</a></p>
</section>
<section id="clone-chap-core-github-repository">
<h2>2. Clone CHAP Core GitHub-Repository<a class="headerlink" href="#clone-chap-core-github-repository" title="Link to this heading">¶</a></h2>
<p>You need to clone the CHAP Core repository from GitHub. Open your terminal and run the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/dhis2-chap/chap-core.git
</pre></div>
</div>
</section>
<section id="add-credentials-for-google-earth-engine">
<h2>3. Add Credentials for Google Earth Engine<a class="headerlink" href="#add-credentials-for-google-earth-engine" title="Link to this heading">¶</a></h2>
<ol class="arabic">
<li><p>Open your terminal and navigate to the “chap-core” repository you cloned:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>chap-core
</pre></div>
</div>
</li>
<li><p>Open the “chap-core” repository in your code editor. For example, if you are using Visual Studio Code, you can use the following command in the terminal:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>code<span class="w"> </span>.
</pre></div>
</div>
</li>
<li><p>In your code editor, create a new file at the root level of the repository and name it <code class="docutils literal notranslate"><span class="pre">.env</span></code>.</p></li>
<li><p>Add the following environment variables to the <code class="docutils literal notranslate"><span class="pre">.env</span></code> file. Replace the placeholder values with your actual Google Service Account credentials:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">GOOGLE_SERVICE_ACCOUNT_EMAIL</span><span class="o">=</span><span class="s2">&quot;your-google-service-account@company.iam.gserviceaccount.com&quot;</span>
<span class="nv">GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY</span><span class="o">=</span><span class="s2">&quot;-----BEGIN PRIVATE KEY-----&lt;your-private-key&gt;-----END PRIVATE KEY-----&quot;</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="start-chap-core">
<h2>4. Start CHAP Core<a class="headerlink" href="#start-chap-core" title="Link to this heading">¶</a></h2>
<p>At the root level of the repository (the same level you placed the .env-file), run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker-compose<span class="w"> </span>up
</pre></div>
</div>
<p><strong>This will build three images and start the following containers:</strong></p>
<ul class="simple">
<li><p>A REST-API (FastAPI)</p></li>
<li><p>A Redis server</p></li>
<li><p>A worker service</p></li>
</ul>
<p>You can go to <a class="reference external" href="http://localhost:8000/docs">http://localhost:8000/docs</a> to verify that the REST-API is working. A Swagger page, as shown below, should display:</p>
<p><img alt="Swagger UI" src="../_images/swagger-fastapi.png" /></p>
</section>
<section id="stop-chap-core">
<h2>5. Stop CHAP Core<a class="headerlink" href="#stop-chap-core" title="Link to this heading">¶</a></h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker-compose<span class="w"> </span>down
</pre></div>
</div>
</section>
<section id="logs">
<h2>Logs<a class="headerlink" href="#logs" title="Link to this heading">¶</a></h2>
<p>When running things with docker compose, some logging will be done by each container. These are written to the <code class="docutils literal notranslate"><span class="pre">logs</span></code>-directory, and can be useful for debugging purposes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">logs/rest_api.log</span></code>: This contains logs part of the chap-core rest api</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logs/worker.log</span></code>: This contains logs from the worker running the models. This should be checked if a model for some reason fails</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logs/tas_{task_id}.log</span></code>: One log file is generated for each task (typically model run). The task_id is the internal task id for the Celery task.</p></li>
</ul>
</section>
</section>
<section id="data-requirements-in-chap">
<h1>Data requirements in CHAP<a class="headerlink" href="#data-requirements-in-chap" title="Link to this heading">¶</a></h1>
<p>CHAP expects the data to contain certain features as column names of the supplied csv files. Specifically, time_period, population, disease_cases, location, rainfall and mean_temperature. CHAP gives an error if any of these are missing in the supplied datafile. Additionally, there are convntions for how to represent time in the time_period. For instance, weekly data should be represented as</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>time_period</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2014-12-29/2015-01-04</p></td>
</tr>
<tr class="row-odd"><td><p>2015-01-05/2015-01-11</p></td>
</tr>
<tr class="row-even"><td><p>2015-01-12/2015-01-18</p></td>
</tr>
<tr class="row-odd"><td><p>2015-01-19/2015-01-25</p></td>
</tr>
</tbody>
</table>
</div>
<p>And for monthly data it should be</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>time_period</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2014-12</p></td>
</tr>
<tr class="row-odd"><td><p>2015-01</p></td>
</tr>
<tr class="row-even"><td><p>2015-02</p></td>
</tr>
<tr class="row-odd"><td><p>2015-03</p></td>
</tr>
</tbody>
</table>
</div>
<p>This requirement is checked for supplied data files for training and predicitng and also for the output data from the model. Additionaly the model should give samples from a distribuition, preferable $1000$ samples for each location and time index with column names <code class="docutils literal notranslate"><span class="pre">sample_0,</span> <span class="pre">sample_1</span></code> and so on.</p>
<p>A useful tool for handling data is the adapters that can be included in the MLproject file. These adapters map the internal names in CHAP to whatever you want them to be. For instance disease_cases could be mapped to cases, as in the MLproject file in the repository under the <a class="reference external" href="https://github.com/dhis2-chap/chap_auto_ewars_weekly">dhis2-chap organization</a>. In practice, the adapters copy the mentioned column and gives it the new column name.</p>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; CHAP
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=fc837d61"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>