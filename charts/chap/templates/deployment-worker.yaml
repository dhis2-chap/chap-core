apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "chap.fullname" . }}-worker
  labels:
    {{- include "chap.labels" . | nindent 4 }}
    component: worker
spec:
  replicas: {{ .Values.worker.replicaCount }}
  selector:
    matchLabels:
      {{- include "chap.selectorLabels" . | nindent 6 }}
      component: worker
  template:
    metadata:
      labels:
        {{- include "chap.labels" . | nindent 8 }}
        component: worker
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "chap.serviceAccountName" . }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: {{ include "chap.fullname" . }}-worker
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default "latest" }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            {{- toYaml .Values.worker.command | nindent 12 }}
          {{- with .Values.worker.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          env:
            - name: IS_IN_DOCKER
              value: "1"
            - name: CHAP_DATABASE_URL
              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB)"
            - name: CELERY_BROKER
              value: "redis://:$(REDIS_PASSWORD)@$(REDIS_HOST):$(REDIS_PORT)/0"
            - name: RENV_PATHS_ROOT
              value: /data/renv
            - name: UV_CACHE_DIR
              value: /data/uv
            - name: CHAP_LOGS_DIR
              value: /data/logs
            - name: CHAP_RUNS_DIR
              value: /data/runs
            - name: PYTENSOR_FLAGS
              value: "base_compiledir=/data/pytensor"
            - name: POSTGRES_USER
              {{- if .Values.postgresql.existingSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.existingSecret }}
                  key: {{ .Values.postgresql.secretKeys.username }}
              {{- else if .Values.postgresql.managed.enabled }}
              valueFrom:
                secretKeyRef:
                  name: {{ include "chap.fullname" . }}-postgres-app
                  key: username
              {{- else }}
              value: postgres
              {{- end }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  {{- if .Values.postgresql.existingSecret }}
                  name: {{ .Values.postgresql.existingSecret }}
                  key: {{ .Values.postgresql.secretKeys.password }}
                  {{- else if .Values.postgresql.managed.enabled }}
                  name: {{ include "chap.fullname" . }}-postgres-app
                  key: password
                  {{- else }}
                  name: {{ include "chap.fullname" . }}
                  key: POSTGRES_PASSWORD
                  {{- end }}
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chap.fullname" . }}
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chap.fullname" . }}
                  key: POSTGRES_PORT
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chap.fullname" . }}
                  key: POSTGRES_DB
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chap.fullname" . }}
                  key: REDIS_HOST
            - name: REDIS_PORT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chap.fullname" . }}
                  key: REDIS_PORT
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  {{- if .Values.valkeyConnection.existingSecret }}
                  name: {{ .Values.valkeyConnection.existingSecret }}
                  key: {{ .Values.valkeyConnection.secretKeys.password }}
                  {{- else }}
                  name: {{ include "chap.fullname" . }}
                  key: REDIS_PASSWORD
                  {{- end }}
            - name: GOOGLE_SERVICE_ACCOUNT_EMAIL
              valueFrom:
                secretKeyRef:
                  name: {{ include "chap.fullname" . }}
                  key: GOOGLE_SERVICE_ACCOUNT_EMAIL
            - name: GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "chap.fullname" . }}
                  key: GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY
          envFrom:
            - configMapRef:
                name: {{ include "chap.fullname" . }}
          volumeMounts:
            - name: tmpfs
              mountPath: /tmp
            - name: runs
              mountPath: /data/runs
            - name: renv
              mountPath: /data/renv
            - name: uv
              mountPath: /data/uv
            - name: logs
              mountPath: /data/logs
            - name: pytensor
              mountPath: /data/pytensor
          {{- with .Values.worker.volumeMounts }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
      volumes:
        - name: tmpfs
          emptyDir:
            medium: Memory
            sizeLimit: 2Gi
        - name: runs
          emptyDir: {}
        - name: renv
          emptyDir: {}
        - name: uv
          emptyDir: {}
        - name: logs
          emptyDir: {}
        - name: pytensor
          emptyDir: {}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
